{"AWSTemplateFormatVersion": "2010-09-09", "Parameters": {"AmiId": {"Default": "", "Type": "String", "Description": "AMI ID for Launch Configuration"}, "CraftElbSubnetAz3": {"Default": "", "Type": "String", "Description": "Subnet for Craft ELB in AZ3"}, "ElbSecurityGroups": {"Default": "", "Type": "String", "Description": "Security Groups assigned to ELB"}, "InstanceSecurityGroups": {"Default": "", "Type": "String", "Description": "Security Groups assigned to instances in ASG"}, "VpcZoneIdentifierAz1": {"Default": "", "Type": "String", "Description": "VPC Zone Id used for ASG in AZ1"}, "CraftElbSubnetAz1": {"Default": "", "Type": "String", "Description": "Subnet for Craft ELB in AZ1"}, "CraftElbSubnetAz2": {"Default": "", "Type": "String", "Description": "Subnet for Craft ELB in AZ2"}, "VpcZoneIdentifierAz2": {"Default": "", "Type": "String", "Description": "VPC Zone Id used for ASG in AZ2"}, "SnsTopic": {"Default": "", "Type": "String", "Description": "SNS Topic to be used in bootstrap"}, "Environment": {"Default": "", "Type": "String", "Description": "Environment of the stack"}, "ElbName": {"Default": "", "Type": "String", "Description": "Name, including environment, of ELB"}, "IamInstanceProfile": {"Default": "", "Type": "String", "Description": "IAM Instance Profile ARN"}, "InstanceType": {"Default": "", "Type": "String", "Description": "Instance Type"}, "VpcZoneIdentifierAz3": {"Default": "", "Type": "String", "Description": "VPC Zone Id used for ASG in AZ3"}}, "Description": "Craft", "Resources": {"CraftHighElbLatencyAlarm": {"Type": "AWS::CloudWatch::Alarm", "Properties": {"EvaluationPeriods": "1", "Dimensions": [{"Name": "LoadBalancerName", "Value": {"Ref": "CraftElb"}}], "AlarmActions": [{"Ref": "SnsTopic"}], "AlarmDescription": "Signal alarm if ELB Latency is above threshold", "Namespace": "AWS/ELB", "Period": "60", "ComparisonOperator": "GreaterThanOrEqualToThreshold", "Statistic": "Average", "Threshold": "60", "MetricName": "Latency"}}, "CraftAsg": {"Type": "AWS::AutoScaling::AutoScalingGroup", "Properties": {"HealthCheckGracePeriod": 300, "DesiredCapacity": 2, "NotificationConfigurations": [{"NotificationTypes": ["autoscaling:EC2_INSTANCE_LAUNCH", "autoscaling:EC2_INSTANCE_TERMINATE"], "TopicARN": {"Ref": "SnsTopic"}}], "Tags": [{"PropagateAtLaunch": true, "Value": {"Fn::Join": ["", [{"Ref": "Environment"}, "-Craft-Asg"]]}, "Key": "Name"}, {"PropagateAtLaunch": true, "Value": {"Ref": "Environment"}, "Key": "Environment"}, {"PropagateAtLaunch": true, "Value": "ShelterMutual", "Key": "project"}], "LoadBalancerNames": [{"Ref": "CraftElb"}], "MinSize": 2, "MaxSize": 3, "VPCZoneIdentifier": [{"Ref": "VpcZoneIdentifierAz1"}, {"Ref": "VpcZoneIdentifierAz2"}, {"Ref": "VpcZoneIdentifierAz3"}], "LaunchConfigurationName": {"Ref": "CraftLaunchConfig"}, "AvailabilityZones": [{"Fn::Select": ["0", {"Fn::GetAZs": ""}]}, {"Fn::Select": ["1", {"Fn::GetAZs": ""}]}, {"Fn::Select": ["2", {"Fn::GetAZs": ""}]}], "HealthCheckType": "EC2"}, "UpdatePolicy": {"AutoScalingRollingUpdate": {"PauseTime": "PT0M30S", "MaxBatchSize": "1", "MinInstancesInService": "1"}}}, "CraftLowCpuAlarm": {"Type": "AWS::CloudWatch::Alarm", "Properties": {"EvaluationPeriods": "1", "Dimensions": [{"Name": "AutoScalingGroupName", "Value": {"Ref": "CraftAsg"}}], "AlarmActions": [{"Ref": "SnsTopic"}, {"Ref": "CraftScaleDownPolicy"}], "AlarmDescription": "Signal alarm if CPU utilization is below threshold", "Namespace": "AWS/EC2", "Period": "120", "ComparisonOperator": "LessThanOrEqualToThreshold", "Statistic": "Average", "Threshold": "40", "MetricName": "CPUUtilization"}}, "CraftRootDiskWriteOps": {"Type": "AWS::CloudWatch::Alarm", "Properties": {"EvaluationPeriods": "1", "Dimensions": [{"Name": "AutoScalingGroupName", "Value": {"Ref": "CraftAsg"}}], "AlarmActions": [{"Ref": "SnsTopic"}], "AlarmDescription": "Send alert if DiskWriteOps is greater than ~90%", "Namespace": "AWS/EC2", "Period": "300", "ComparisonOperator": "GreaterThanOrEqualToThreshold", "Statistic": "Average", "Threshold": "27", "MetricName": "DiskWriteOps"}}, "CraftScaleUpPolicy": {"Type": "AWS::AutoScaling::ScalingPolicy", "Properties": {"ScalingAdjustment": "1", "AutoScalingGroupName": {"Ref": "CraftAsg"}, "Cooldown": 300, "AdjustmentType": "ChangeInCapacity"}}, "CraftScaleDownPolicy": {"Type": "AWS::AutoScaling::ScalingPolicy", "Properties": {"ScalingAdjustment": "-1", "AutoScalingGroupName": {"Ref": "CraftAsg"}, "Cooldown": 120, "AdjustmentType": "ChangeInCapacity"}}, "CraftRootDiskReadOps": {"Type": "AWS::CloudWatch::Alarm", "Properties": {"EvaluationPeriods": "1", "Dimensions": [{"Name": "AutoScalingGroupName", "Value": {"Ref": "CraftAsg"}}], "AlarmActions": [{"Ref": "SnsTopic"}], "AlarmDescription": "Send alert if DiskReadOps is greater than ~90%", "Namespace": "AWS/EC2", "Period": "300", "ComparisonOperator": "GreaterThanOrEqualToThreshold", "Statistic": "Average", "Threshold": "27", "MetricName": "DiskReadOps"}}, "CraftElb": {"Type": "AWS::ElasticLoadBalancing::LoadBalancer", "Properties": {"ConnectionDrainingPolicy": {"Enabled": true, "Timeout": "120"}, "Subnets": [{"Ref": "CraftElbSubnetAz1"}, {"Ref": "CraftElbSubnetAz2"}, {"Ref": "CraftElbSubnetAz3"}], "HealthCheck": {"HealthyThreshold": "2", "Interval": "10", "Target": "TCP:80", "Timeout": "5", "UnhealthyThreshold": "5"}, "Listeners": [{"InstancePort": "80", "LoadBalancerPort": "80", "Protocol": "HTTP", "InstanceProtocol": "HTTP"}], "CrossZone": "true", "SecurityGroups": [{"Ref": "ElbSecurityGroups"}], "LoadBalancerName": {"Ref": "ElbName"}, "Scheme": "internet-facing"}}, "CraftElbHealthyHosts": {"Type": "AWS::CloudWatch::Alarm", "Properties": {"EvaluationPeriods": "1", "Dimensions": [{"Name": "LoadBalancerName", "Value": {"Ref": "CraftElb"}}], "AlarmActions": [{"Ref": "SnsTopic"}], "AlarmDescription": "Send alert if number of healthy host is below minimum # of instances", "Namespace": "AWS/ELB", "Period": "60", "ComparisonOperator": "LessThanThreshold", "Statistic": "Average", "Threshold": "2", "MetricName": "HealthyHostCount"}}, "CraftHighCpuAlarm": {"Type": "AWS::CloudWatch::Alarm", "Properties": {"EvaluationPeriods": "1", "Dimensions": [{"Name": "AutoScalingGroupName", "Value": {"Ref": "CraftAsg"}}], "AlarmActions": [{"Ref": "SnsTopic"}, {"Ref": "CraftScaleUpPolicy"}], "AlarmDescription": "Signal alarm if CPU utilization is above threshold", "Namespace": "AWS/EC2", "Period": "300", "ComparisonOperator": "GreaterThanOrEqualToThreshold", "Statistic": "Average", "Threshold": "85", "MetricName": "CPUUtilization"}}, "CraftLaunchConfig": {"Type": "AWS::AutoScaling::LaunchConfiguration", "Properties": {"UserData": {"Fn::Base64": {"Fn::Join": ["", ["#!/usr/bin/env bash\n", "export PROJECT=", "sheltermutual", "\n", "export ROLE=", "craft", "\nexport ENV=", {"Ref": "Environment"}, "\n", "export SNS_TOPIC=", {"Ref": "SnsTopic"}, "\n", "if [ $(which apt-get) ] ; then", "\n", "export DEBIAN_FRONTEND=noninteractive", "\n", "apt-get update", "\n", "apt-get -y install python-pip", "\n", "elif [ $(which yum) ] ; then", "\n", "if [ -e /etc/redhat-release ]; then", "\n", "yum -y install wget", "\n", "RELEASE=$(cut -d ' ' -f 7 /etc/redhat-release | cut -d '.' -f 1)", "\n", "wget https://dl.fedoraproject.org/pub/epel/epel-release-latest-${RELEASE}.noarch.rpm", "\n", "rpm -Uvh epel-release*.rpm", "\n", "else", "\n", "yum -y install epel-release", "\n", "fi", "\n", "yum makecache fast", "\n", "yum -y install python-pip", "\n", "fi", "\n", "pip install --upgrade awscli", "\n", "aws s3 cp s3://", "shelter-mutual-aws-tools-us-east-1/bootstrap", "/", "craft", ".sh", " /usr/local/bin/", "craft", ".sh", " --region ", {"Ref": "AWS::Region"}, " \n", "chmod 770 /usr/local/bin/", "craft", ".sh", " \n", "/usr/local/bin/", "craft", ".sh", "\n"]]}}, "ImageId": {"Ref": "AmiId"}, "BlockDeviceMappings": [{"DeviceName": "/dev/sda1", "Ebs": {"DeleteOnTermination": "true", "VolumeType": "gp2", "VolumeSize": 10}}], "KeyName": "common-us-east-1", "SecurityGroups": [{"Ref": "InstanceSecurityGroups"}], "IamInstanceProfile": {"Ref": "IamInstanceProfile"}, "InstanceType": {"Ref": "InstanceType"}, "AssociatePublicIpAddress": "false"}}}}