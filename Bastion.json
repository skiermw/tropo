{"AWSTemplateFormatVersion": "2010-09-09", "Parameters": {"AmiId": {"Default": "", "Type": "String", "Description": "AMI ID for Launch Configuration"}, "InstanceSecurityGroups": {"Default": "", "Type": "String", "Description": "Security Groups assigned to instances in ASG"}, "VpcZoneIdentifierAz1": {"Default": "", "Type": "String", "Description": "VPC Zone Id used for ASG in AZ1"}, "VpcZoneIdentifierAz3": {"Default": "", "Type": "String", "Description": "VPC Zone Id used for ASG in AZ3"}, "VpcZoneIdentifierAz2": {"Default": "", "Type": "String", "Description": "VPC Zone Id used for ASG in AZ2"}, "SnsTopic": {"Default": "", "Type": "String", "Description": "SNS Topic to be used in bootstrap"}, "IamInstanceProfile": {"Default": "", "Type": "String", "Description": "IAM Instance Profile ARN"}}, "Description": "Bastion", "Resources": {"BastionAsg": {"Type": "AWS::AutoScaling::AutoScalingGroup", "Properties": {"HealthCheckGracePeriod": "300", "DesiredCapacity": "1", "Tags": [{"PropagateAtLaunch": true, "Value": {"Fn::Join": ["", ["Test", "-Bastion-Asg"]]}, "Key": "Name"}, {"PropagateAtLaunch": true, "Value": "ShelterMutual", "Key": "project"}], "MinSize": "1", "MaxSize": "2", "VPCZoneIdentifier": [{"Ref": "VpcZoneIdentifierAz1"}, {"Ref": "VpcZoneIdentifierAz2"}, {"Ref": "VpcZoneIdentifierAz3"}], "LaunchConfigurationName": {"Ref": "BastionLaunchConfig"}, "AvailabilityZones": [{"Fn::Select": ["0", {"Fn::GetAZs": ""}]}, {"Fn::Select": ["1", {"Fn::GetAZs": ""}]}, {"Fn::Select": ["2", {"Fn::GetAZs": ""}]}], "HealthCheckType": "EC2"}, "UpdatePolicy": {"AutoScalingRollingUpdate": {"PauseTime": "PT0M30S", "MaxBatchSize": "1", "MinInstancesInService": "1"}}}, "BastionLaunchConfig": {"Type": "AWS::AutoScaling::LaunchConfiguration", "Properties": {"UserData": {"Fn::Base64": {"Fn::Join": ["", ["#!/usr/bin/env bash\n", "yum -y install epel-release\n", "yum -y --enablerepo=epel install python-pip\n", "pip install --upgrade awscli\n", "export PROJECT=", "sheltermutual", "\n", "export ENV=", "test", "\n", "export SNS_TOPIC=", {"Ref": "SnsTopic"}, "\n", "aws s3 cp s3://", "shelter-mutual-aws-tools-us-east-1/bootstrap", "/bastion.sh", " /usr/local/bin/bastion.sh", " --region ", {"Ref": "AWS::Region"}, " \n", "chmod 770 /usr/local/bin/bastion.sh", " \n", "/usr/local/bin/bastion.sh", " \n"]]}}, "ImageId": {"Ref": "AmiId"}, "BlockDeviceMappings": [{"DeviceName": "/dev/xvda", "Ebs": {"DeleteOnTermination": "true", "VolumeType": "gp2", "VolumeSize": "10"}}], "KeyName": "bastion-us-east-1", "SecurityGroups": [{"Ref": "InstanceSecurityGroups"}], "IamInstanceProfile": {"Ref": "IamInstanceProfile"}, "InstanceType": "t2.micro", "AssociatePublicIpAddress": "true"}}, "BastionAlarm": {"Type": "AWS::CloudWatch::Alarm", "Properties": {"EvaluationPeriods": "1", "Dimensions": [{"Name": "AutoScalingGroupName", "Value": {"Ref": "BastionAsg"}}], "AlarmActions": [{"Ref": "SnsTopic"}], "AlarmDescription": "High CPU", "Namespace": "AWS/EC2", "Period": "60", "ComparisonOperator": "GreaterThanOrEqualToThreshold", "Statistic": "Average", "Threshold": "90", "MetricName": "CPUUtilization"}}}}