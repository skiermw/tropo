{"AWSTemplateFormatVersion": "2010-09-09", "Parameters": {"AmiId": {"Default": "", "Type": "String", "Description": "AMI ID for Launch Configuration"}, "InstanceSecurityGroups": {"Default": "", "Type": "String", "Description": "Security Groups assigned to instances in ASG"}, "VpcZoneIdentifierAz1": {"Default": "", "Type": "String", "Description": "VPC Zone Id used for ASG in AZ1"}, "VpcZoneIdentifierAz3": {"Default": "", "Type": "String", "Description": "VPC Zone Id used for ASG in AZ3"}, "VpcZoneIdentifierAz2": {"Default": "", "Type": "String", "Description": "VPC Zone Id used for ASG in AZ2"}, "SnsTopic": {"Default": "", "Type": "String", "Description": "SNS Topic to be used in bootstrap"}, "IamInstanceProfile": {"Default": "", "Type": "String", "Description": "IAM Instance Profile ARN"}, "InstanceType": {"Default": "t2.micro", "Type": "String", "Description": "Instance Type"}}, "Description": "NAT", "Resources": {"AsgLaunchConfiguration": {"Type": "AWS::AutoScaling::LaunchConfiguration", "Properties": {"UserData": {"Fn::Base64": {"Fn::Join": ["", ["#!/usr/bin/env bash\n", "yum -y install epel-release\n", "yum -y --enablerepo=epel install python-pip\n", "pip install --upgrade awscli\n", "export PROJECT=", "sheltermutual", "\n", "export ENV=", "test", "\n", "export SNS_TOPIC=", {"Ref": "SnsTopic"}, "\n", "aws s3 cp s3://", "shelter-mutual-aws-tools-us-east-1/bootstrap", "/nat.sh", " /usr/local/bin/nat.sh", " --region ", {"Ref": "AWS::Region"}, " \n", "chmod 770 /usr/local/bin/nat.sh", " \n", "/usr/local/bin/nat.sh", " \n"]]}}, "ImageId": {"Ref": "AmiId"}, "BlockDeviceMappings": [{"DeviceName": "/dev/xvda", "Ebs": {"DeleteOnTermination": "true", "VolumeType": "gp2", "VolumeSize": "10"}}], "KeyName": "common-us-east-1", "SecurityGroups": [{"Ref": "InstanceSecurityGroups"}], "IamInstanceProfile": {"Ref": "IamInstanceProfile"}, "InstanceType": {"Ref": "InstanceType"}, "AssociatePublicIpAddress": "true"}}, "NatAz2Alarm": {"Type": "AWS::CloudWatch::Alarm", "Properties": {"EvaluationPeriods": "1", "Dimensions": [{"Name": "AutoScalingGroupName", "Value": {"Ref": "NatAz2"}}], "AlarmActions": [{"Ref": "SnsTopic"}], "AlarmDescription": "High CPU", "Namespace": "AWS/EC2", "Period": "60", "ComparisonOperator": "GreaterThanOrEqualToThreshold", "Statistic": "Average", "Threshold": "90", "MetricName": "CPUUtilization"}}, "NatAz2": {"Type": "AWS::AutoScaling::AutoScalingGroup", "Properties": {"HealthCheckGracePeriod": "300", "DesiredCapacity": "1", "Tags": [{"PropagateAtLaunch": true, "Value": "Test-Nat-Asg-Az2", "Key": "Name"}, {"PropagateAtLaunch": true, "Value": "ShelterMutual", "Key": "project"}, {"PropagateAtLaunch": true, "Value": "AZ2", "Key": "WhichAZ"}], "MinSize": "1", "MaxSize": "2", "VPCZoneIdentifier": [{"Ref": "VpcZoneIdentifierAz2"}], "LaunchConfigurationName": {"Ref": "AsgLaunchConfiguration"}, "AvailabilityZones": [{"Fn::Select": ["1", {"Fn::GetAZs": ""}]}], "HealthCheckType": "EC2"}}, "NatAz3": {"Type": "AWS::AutoScaling::AutoScalingGroup", "Properties": {"HealthCheckGracePeriod": "300", "DesiredCapacity": "1", "Tags": [{"PropagateAtLaunch": true, "Value": "Test-Nat-Asg-Az3", "Key": "Name"}, {"PropagateAtLaunch": true, "Value": "ShelterMutual", "Key": "project"}, {"PropagateAtLaunch": true, "Value": "AZ3", "Key": "WhichAZ"}], "MinSize": "1", "MaxSize": "2", "VPCZoneIdentifier": [{"Ref": "VpcZoneIdentifierAz3"}], "LaunchConfigurationName": {"Ref": "AsgLaunchConfiguration"}, "AvailabilityZones": [{"Fn::Select": ["2", {"Fn::GetAZs": ""}]}], "HealthCheckType": "EC2"}}, "NatAz1": {"Type": "AWS::AutoScaling::AutoScalingGroup", "Properties": {"HealthCheckGracePeriod": "300", "DesiredCapacity": "1", "Tags": [{"PropagateAtLaunch": true, "Value": "Test-Nat-Asg-Az1", "Key": "Name"}, {"PropagateAtLaunch": true, "Value": "ShelterMutual", "Key": "project"}, {"PropagateAtLaunch": true, "Value": "AZ1", "Key": "WhichAZ"}], "MinSize": "1", "MaxSize": "2", "VPCZoneIdentifier": [{"Ref": "VpcZoneIdentifierAz1"}], "LaunchConfigurationName": {"Ref": "AsgLaunchConfiguration"}, "AvailabilityZones": [{"Fn::Select": ["0", {"Fn::GetAZs": ""}]}], "HealthCheckType": "EC2"}}, "NatAz3Alarm": {"Type": "AWS::CloudWatch::Alarm", "Properties": {"EvaluationPeriods": "1", "Dimensions": [{"Name": "AutoScalingGroupName", "Value": {"Ref": "NatAz3"}}], "AlarmActions": [{"Ref": "SnsTopic"}], "AlarmDescription": "High CPU", "Namespace": "AWS/EC2", "Period": "60", "ComparisonOperator": "GreaterThanOrEqualToThreshold", "Statistic": "Average", "Threshold": "90", "MetricName": "CPUUtilization"}}, "NatAz1Alarm": {"Type": "AWS::CloudWatch::Alarm", "Properties": {"EvaluationPeriods": "1", "Dimensions": [{"Name": "AutoScalingGroupName", "Value": {"Ref": "NatAz1"}}], "AlarmActions": [{"Ref": "SnsTopic"}], "AlarmDescription": "High CPU", "Namespace": "AWS/EC2", "Period": "60", "ComparisonOperator": "GreaterThanOrEqualToThreshold", "Statistic": "Average", "Threshold": "90", "MetricName": "CPUUtilization"}}}}