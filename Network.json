{"AWSTemplateFormatVersion": "2010-09-09", "Outputs": {"SubnetTestPrivateAz2Id": {"Description": "SubnetTestPrivateAz2 ID", "Value": {"Ref": "SubnetTestPrivateAz2"}}, "SubnetTestRdsAz2Id": {"Description": "SubnetTestRdsAz2 ID", "Value": {"Ref": "SubnetTestRdsAz2"}}, "SubnetTestPrivateAz1Id": {"Description": "SubnetTestPrivateAz1 ID", "Value": {"Ref": "SubnetTestPrivateAz1"}}, "SubnetTestPublicAz1Id": {"Description": "SubnetTestPublicAz1 ID", "Value": {"Ref": "SubnetTestPublicAz1"}}, "SubnetTestRdsAz3Id": {"Description": "SubnetTestRdsAz3 ID", "Value": {"Ref": "SubnetTestRdsAz3"}}, "NatSecurityGroupId": {"Description": "NAT Security Group ID", "Value": {"Ref": "NatSecurityGroup"}}, "SubnetTestRdsAz1Id": {"Description": "SubnetTestRdsAz1 ID", "Value": {"Ref": "SubnetTestRdsAz1"}}, "SubnetTestPublicAz3Id": {"Description": "SubnetTestPublicAz3 ID", "Value": {"Ref": "SubnetTestPublicAz3"}}, "VpcId": {"Description": "VPC ID", "Value": {"Ref": "VPC"}}, "SubnetTestPublicAz2Id": {"Description": "SubnetTestPublicAz2 ID", "Value": {"Ref": "SubnetTestPublicAz2"}}, "SubnetTestPrivateAz3Id": {"Description": "SubnetTestPrivateAz3 ID", "Value": {"Ref": "SubnetTestPrivateAz3"}}}, "Description": "Network", "Resources": {"RdsSubnetGroupTest": {"Type": "AWS::RDS::DBSubnetGroup", "Properties": {"SubnetIds": [{"Ref": "SubnetTestRdsAz1"}, {"Ref": "SubnetTestRdsAz2"}, {"Ref": "SubnetTestRdsAz3"}], "DBSubnetGroupDescription": "Subnets for RDS Test"}}, "DhcpOptions": {"Type": "AWS::EC2::DHCPOptions", "Properties": {"DomainName": "sheltermutual-aws.internal", "DomainNameServers": ["AmazonProvidedDNS"], "Tags": [{"Key": "Name", "Value": "VPC_DHCP"}, {"Key": "project", "Value": "ShelterMutual"}]}}, "PrivateSubnetRouteTableAssociationSubnetTestRdsAz1": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetTestRdsAz1"}, "RouteTableId": {"Ref": "PrivateRouteTableAz1"}}}, "PublicRoute": {"Type": "AWS::EC2::Route", "Properties": {"GatewayId": {"Ref": "InternetGateway"}, "DestinationCidrBlock": "0.0.0.0/0", "RouteTableId": {"Ref": "PublicRouteTable"}}, "DependsOn": "AttachGateway"}, "PrivateSubnetRouteTableAssociationSubnetTestRdsAz3": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetTestRdsAz3"}, "RouteTableId": {"Ref": "PrivateRouteTableAz3"}}}, "PrivateSubnetRouteTableAssociationSubnetTestRdsAz2": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetTestRdsAz2"}, "RouteTableId": {"Ref": "PrivateRouteTableAz2"}}}, "InternetGateway": {"Type": "AWS::EC2::InternetGateway", "Properties": {"Tags": [{"Key": "project", "Value": "ShelterMutual"}]}}, "RdsNaclAssociationTestAz2": {"Type": "AWS::EC2::SubnetNetworkAclAssociation", "Properties": {"SubnetId": {"Ref": "SubnetTestRdsAz2"}, "NetworkAclId": {"Ref": "RdsTestNacl"}}}, "RdsNaclAssociationTestAz3": {"Type": "AWS::EC2::SubnetNetworkAclAssociation", "Properties": {"SubnetId": {"Ref": "SubnetTestRdsAz3"}, "NetworkAclId": {"Ref": "RdsTestNacl"}}}, "RdsNaclAssociationTestAz1": {"Type": "AWS::EC2::SubnetNetworkAclAssociation", "Properties": {"SubnetId": {"Ref": "SubnetTestRdsAz1"}, "NetworkAclId": {"Ref": "RdsTestNacl"}}}, "NatSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"SecurityGroupIngress": [{"ToPort": "-1", "FromPort": "-1", "CidrIp": "192.168.128.0/21", "IpProtocol": "icmp"}, {"ToPort": "65535", "FromPort": "0", "CidrIp": "192.168.128.0/21", "IpProtocol": "udp"}, {"ToPort": "65535", "FromPort": "0", "CidrIp": "192.168.128.0/21", "IpProtocol": "tcp"}], "VpcId": {"Ref": "VPC"}, "GroupDescription": "Enable communication to NAT Gateway(s).", "SecurityGroupEgress": [{"ToPort": "-1", "FromPort": "-1", "CidrIp": "0.0.0.0/0", "IpProtocol": "icmp"}, {"ToPort": "65535", "FromPort": "0", "CidrIp": "0.0.0.0/0", "IpProtocol": "udp"}, {"ToPort": "65535", "FromPort": "0", "CidrIp": "0.0.0.0/0", "IpProtocol": "tcp"}]}}, "EipNatAz3": {"Type": "AWS::EC2::EIP", "Properties": {"Domain": "vpc"}}, "PrivateRouteTableAz2": {"Type": "AWS::EC2::RouteTable", "Properties": {"VpcId": {"Ref": "VPC"}, "Tags": [{"Key": "Name", "Value": "PrivateRouteTableAz2"}]}}, "SubnetTestPublicAz1": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": "SubnetTestPublicAz1"}, {"Key": "project", "Value": "ShelterMutual"}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::FindInMap": ["SubnetMap", "TEST-PUBLIC-AZ1", "CIDR"]}, "AvailabilityZone": {"Fn::Select": ["0", {"Fn::GetAZs": ""}]}}}, "SubnetTestPublicAz2": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": "SubnetTestPublicAz2"}, {"Key": "project", "Value": "ShelterMutual"}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::FindInMap": ["SubnetMap", "TEST-PUBLIC-AZ2", "CIDR"]}, "AvailabilityZone": {"Fn::Select": ["1", {"Fn::GetAZs": ""}]}}}, "SubnetTestPublicAz3": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": "SubnetTestPublicAz3"}, {"Key": "project", "Value": "ShelterMutual"}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::FindInMap": ["SubnetMap", "TEST-PUBLIC-AZ3", "CIDR"]}, "AvailabilityZone": {"Fn::Select": ["2", {"Fn::GetAZs": ""}]}}}, "PrivateSubnetRouteTableAssociationSubnetTestPrivateAz1": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetTestPrivateAz1"}, "RouteTableId": {"Ref": "PrivateRouteTableAz1"}}}, "PrivateRouteTableAz1": {"Type": "AWS::EC2::RouteTable", "Properties": {"VpcId": {"Ref": "VPC"}, "Tags": [{"Key": "Name", "Value": "PrivateRouteTableAz1"}]}}, "PrivateSubnetRouteTableAssociationSubnetTestPrivateAz3": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetTestPrivateAz3"}, "RouteTableId": {"Ref": "PrivateRouteTableAz3"}}}, "PrivateSubnetRouteTableAssociationSubnetTestPrivateAz2": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetTestPrivateAz2"}, "RouteTableId": {"Ref": "PrivateRouteTableAz2"}}}, "RdsTestNaclEngress100": {"Type": "AWS::EC2::NetworkAclEntry", "Properties": {"NetworkAclId": {"Ref": "RdsTestNacl"}, "RuleNumber": "100", "Protocol": "-1", "Egress": "true", "RuleAction": "Allow", "CidrBlock": "0.0.0.0/0"}}, "EipNatAz2": {"Type": "AWS::EC2::EIP", "Properties": {"Domain": "vpc"}}, "EipNatAz1": {"Type": "AWS::EC2::EIP", "Properties": {"Domain": "vpc"}}, "VPC": {"Type": "AWS::EC2::VPC", "Properties": {"EnableDnsSupport": "true", "CidrBlock": {"Fn::FindInMap": ["SubnetMap", "VPC", "CIDR"]}, "EnableDnsHostnames": "true", "Tags": [{"Key": "Name", "Value": "ShelterMutual"}, {"Key": "project", "Value": "ShelterMutual"}]}}, "SubnetTestRdsAz3": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": "SubnetTestRdsAz3"}, {"Key": "project", "Value": "ShelterMutual"}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::FindInMap": ["SubnetMap", "TEST-RDS-AZ3", "CIDR"]}, "AvailabilityZone": {"Fn::Select": ["2", {"Fn::GetAZs": ""}]}}}, "SubnetTestRdsAz2": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": "SubnetTestRdsAz2"}, {"Key": "project", "Value": "ShelterMutual"}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::FindInMap": ["SubnetMap", "TEST-RDS-AZ2", "CIDR"]}, "AvailabilityZone": {"Fn::Select": ["1", {"Fn::GetAZs": ""}]}}}, "SubnetTestRdsAz1": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": "SubnetTestRdsAz1"}, {"Key": "project", "Value": "ShelterMutual"}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::FindInMap": ["SubnetMap", "TEST-RDS-AZ1", "CIDR"]}, "AvailabilityZone": {"Fn::Select": ["0", {"Fn::GetAZs": ""}]}}}, "RdsTestNaclIngress200": {"Type": "AWS::EC2::NetworkAclEntry", "Properties": {"NetworkAclId": {"Ref": "RdsTestNacl"}, "RuleNumber": "200", "Protocol": "6", "PortRange": {"To": "3306", "From": "3306"}, "Egress": "false", "RuleAction": "allow", "CidrBlock": {"Fn::FindInMap": ["SubnetMap", "TEST-PRIVATE-AZ2", "CIDR"]}}}, "AttachGateway": {"Type": "AWS::EC2::VPCGatewayAttachment", "Properties": {"VpcId": {"Ref": "VPC"}, "InternetGatewayId": {"Ref": "InternetGateway"}}}, "RdsTestNaclIngress300": {"Type": "AWS::EC2::NetworkAclEntry", "Properties": {"NetworkAclId": {"Ref": "RdsTestNacl"}, "RuleNumber": "300", "Protocol": "6", "PortRange": {"To": "3306", "From": "3306"}, "Egress": "false", "RuleAction": "allow", "CidrBlock": {"Fn::FindInMap": ["SubnetMap", "TEST-PRIVATE-AZ3", "CIDR"]}}}, "PrivateRouteAz1": {"Type": "AWS::EC2::Route", "Properties": {"DestinationCidrBlock": "0.0.0.0/0", "NetworkInterfaceId": {"Ref": "EniNatAz1"}, "RouteTableId": {"Ref": "PrivateRouteTableAz1"}}}, "PrivateRouteAz2": {"Type": "AWS::EC2::Route", "Properties": {"DestinationCidrBlock": "0.0.0.0/0", "NetworkInterfaceId": {"Ref": "EniNatAz2"}, "RouteTableId": {"Ref": "PrivateRouteTableAz2"}}}, "PrivateRouteAz3": {"Type": "AWS::EC2::Route", "Properties": {"DestinationCidrBlock": "0.0.0.0/0", "NetworkInterfaceId": {"Ref": "EniNatAz3"}, "RouteTableId": {"Ref": "PrivateRouteTableAz3"}}}, "DhcpOptionsAssociation": {"Type": "AWS::EC2::VPCDHCPOptionsAssociation", "Properties": {"VpcId": {"Ref": "VPC"}, "DhcpOptionsId": {"Ref": "DhcpOptions"}}}, "PrivateRouteTableAz3": {"Type": "AWS::EC2::RouteTable", "Properties": {"VpcId": {"Ref": "VPC"}, "Tags": [{"Key": "Name", "Value": "PrivateRouteTableAz3"}]}}, "PublicSubnetRouteTableAssociationSubnetTestPublicAz1": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetTestPublicAz1"}, "RouteTableId": {"Ref": "PublicRouteTable"}}}, "PublicSubnetRouteTableAssociationSubnetTestPublicAz3": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetTestPublicAz3"}, "RouteTableId": {"Ref": "PublicRouteTable"}}}, "PublicSubnetRouteTableAssociationSubnetTestPublicAz2": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetTestPublicAz2"}, "RouteTableId": {"Ref": "PublicRouteTable"}}}, "EipAssociationNatAz3": {"Type": "AWS::EC2::EIPAssociation", "Properties": {"NetworkInterfaceId": {"Ref": "EniNatAz3"}, "AllocationId": {"Fn::GetAtt": ["EipNatAz3", "AllocationId"]}}}, "EipAssociationNatAz2": {"Type": "AWS::EC2::EIPAssociation", "Properties": {"NetworkInterfaceId": {"Ref": "EniNatAz2"}, "AllocationId": {"Fn::GetAtt": ["EipNatAz2", "AllocationId"]}}}, "EipAssociationNatAz1": {"Type": "AWS::EC2::EIPAssociation", "Properties": {"NetworkInterfaceId": {"Ref": "EniNatAz1"}, "AllocationId": {"Fn::GetAtt": ["EipNatAz1", "AllocationId"]}}}, "PublicRouteTable": {"Type": "AWS::EC2::RouteTable", "Properties": {"VpcId": {"Ref": "VPC"}, "Tags": [{"Key": "Name", "Value": "PublicRouteTable"}]}}, "EniNatAz3": {"Type": "AWS::EC2::NetworkInterface", "Properties": {"SubnetId": {"Ref": "SubnetTestPublicAz3"}, "GroupSet": [{"Ref": "NatSecurityGroup"}], "Description": "Network Interface for Nat in AZ3", "Tags": [{"Key": "Name", "Value": "NatAZ3"}, {"Key": "project", "Value": "ShelterMutual"}]}}, "EniNatAz2": {"Type": "AWS::EC2::NetworkInterface", "Properties": {"SubnetId": {"Ref": "SubnetTestPublicAz2"}, "GroupSet": [{"Ref": "NatSecurityGroup"}], "Description": "Network Interface for Nat in AZ2", "Tags": [{"Key": "Name", "Value": "NatAZ2"}, {"Key": "project", "Value": "ShelterMutual"}]}}, "EniNatAz1": {"Type": "AWS::EC2::NetworkInterface", "Properties": {"SubnetId": {"Ref": "SubnetTestPublicAz1"}, "GroupSet": [{"Ref": "NatSecurityGroup"}], "Description": "Network Interface for Nat in AZ1", "Tags": [{"Key": "Name", "Value": "NatAZ1"}, {"Key": "project", "Value": "ShelterMutual"}]}}, "SubnetTestPrivateAz3": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": "SubnetTestPrivateAz3"}, {"Key": "project", "Value": "ShelterMutual"}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::FindInMap": ["SubnetMap", "TEST-PRIVATE-AZ3", "CIDR"]}, "AvailabilityZone": {"Fn::Select": ["2", {"Fn::GetAZs": ""}]}}}, "SubnetTestPrivateAz2": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": "SubnetTestPrivateAz2"}, {"Key": "project", "Value": "ShelterMutual"}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::FindInMap": ["SubnetMap", "TEST-PRIVATE-AZ2", "CIDR"]}, "AvailabilityZone": {"Fn::Select": ["1", {"Fn::GetAZs": ""}]}}}, "SubnetTestPrivateAz1": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": "SubnetTestPrivateAz1"}, {"Key": "project", "Value": "ShelterMutual"}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::FindInMap": ["SubnetMap", "TEST-PRIVATE-AZ1", "CIDR"]}, "AvailabilityZone": {"Fn::Select": ["0", {"Fn::GetAZs": ""}]}}}, "RdsTestNaclIngress100": {"Type": "AWS::EC2::NetworkAclEntry", "Properties": {"NetworkAclId": {"Ref": "RdsTestNacl"}, "RuleNumber": "100", "Protocol": "6", "PortRange": {"To": "3306", "From": "3306"}, "Egress": "false", "RuleAction": "allow", "CidrBlock": {"Fn::FindInMap": ["SubnetMap", "TEST-PRIVATE-AZ1", "CIDR"]}}}, "RdsTestNacl": {"Type": "AWS::EC2::NetworkAcl", "Properties": {"VpcId": {"Ref": "VPC"}, "Tags": [{"Key": "Name", "Value": "RdsTest"}, {"Key": "project", "Value": "ShelterMutual"}]}}}, "Mappings": {"SubnetMap": {"TEST-PUBLIC-AZ1": {"CIDR": "192.168.128.0/25"}, "TEST-PUBLIC-AZ3": {"CIDR": "192.168.129.0/25"}, "TEST-PUBLIC-AZ2": {"CIDR": "192.168.128.128/25"}, "TEST-PRIVATE-AZ2": {"CIDR": "192.168.130.0/25"}, "TEST-PRIVATE-AZ3": {"CIDR": "192.168.130.128/25"}, "VPC": {"CIDR": "192.168.128.0/21"}, "TEST-PRIVATE-AZ1": {"CIDR": "192.168.129.128/25"}, "TEST-RDS-AZ2": {"CIDR": "192.168.131.128/25"}, "TEST-RDS-AZ3": {"CIDR": "192.168.132.0/25"}, "TEST-RDS-AZ1": {"CIDR": "192.168.131.0/25"}}}}